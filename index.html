<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Calculadora - Valor de la Edificación</title>
  
  <!-- METADATOS PARA COMPORTAMIENTO NATIVO (APP) -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#1e293b" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <!-- Iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* RESET Y ESTILOS BASE PARA MÓVIL */
    body { 
        font-family: 'Inter', sans-serif; 
        overscroll-behavior-y: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }

    input, select { user-select: text; font-size: 16px !important; }
    
    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
    
    #map { z-index: 0; height: 100vh; width: 100vw; position: fixed; top: 0; left: 0; }
    
    .panel-hidden { transform: translateY(100%); opacity: 0; pointer-events: none; }
    .panel-visible { transform: translateY(0); opacity: 1; pointer-events: auto; }
    
    @media (min-width: 768px) {
        .panel-hidden { transform: translateX(-100%); }
        .panel-visible { transform: translateX(0); }
    }
  </style>
</head>

<body class="bg-gray-100 overflow-hidden relative h-screen w-screen">

  <!-- PESTAÑA LATERAL (MÓVIL) -->
  <button id="mobileToggleBtn" class="md:hidden absolute left-0 top-1/2 transform -translate-y-1/2 z-[2000] bg-white text-blue-600 w-6 h-16 rounded-r-lg shadow-lg border-y border-r border-gray-200 flex items-center justify-center hover:bg-gray-50 active:bg-gray-100 transition-all duration-200 group">
    <i id="mobileToggleIcon" class="fa-solid fa-chevron-right text-xs group-active:scale-90 transition-transform"></i>
  </button>

  <!-- PESTAÑA LATERAL (DESKTOP) -->
  <button id="toggleSideBtn" class="hidden md:flex absolute left-0 top-1/2 transform -translate-y-1/2 z-[2000] bg-white text-blue-700 w-8 h-20 rounded-r-xl shadow-xl border-y border-r border-gray-300 items-center justify-center hover:bg-blue-50 transition-all duration-300">
    <i id="toggleIcon" class="fa-solid fa-chevron-left text-lg"></i>
  </button>

  <!-- CONTENEDOR UI -->
  <div id="uiContainer" class="absolute inset-0 z-[1000] pointer-events-none flex flex-col justify-end md:justify-start items-start md:items-stretch transition-all duration-300 w-full h-full md:p-4 md:w-[500px]">
    
    <!-- PANEL PRINCIPAL -->
    <div id="mainPanel" class="panel-visible pointer-events-auto bg-white/95 backdrop-blur-md shadow-2xl flex flex-col w-full h-[100dvh] border-r border-white/20 overflow-hidden transition-all duration-300 ease-in-out md:rounded-2xl md:h-[98%] md:w-full md:max-w-none">
      
      <!-- HEADER -->
      <div class="bg-slate-50/80 p-4 border-b border-gray-200 shrink-0 relative">
        <div class="flex justify-between items-start mt-2">
            <div class="w-full">
                <!-- TEXTO LEGAL -->
                <div class="flex flex-col gap-0.5 mb-2">
                    <span class="text-[9px] font-bold text-blue-600 uppercase tracking-wider leading-tight">R.M. N° 172-2016-VIVIENDA</span>
                    <span class="text-[9px] font-bold text-blue-600 uppercase tracking-wider leading-tight">R.M. N° 277-2025-VIVIENDA</span>
                </div>
                
                <h1 class="text-2xl font-extrabold text-slate-800 leading-none mb-0.5">Calculadora</h1>
                <h2 class="text-lg font-bold text-slate-600 leading-tight">Valor de la edificación</h2>
                
                <p id="selectedDistrictDisplay" class="text-xs text-blue-600 font-semibold mt-2 truncate max-w-[250px]"><i class="fa-solid fa-location-dot mr-1"></i> Selecciona zona en mapa</p>
            </div>
            
            <div class="flex gap-2">
                 <button onclick="resetCalculator()" class="text-xs text-red-500 bg-red-50 p-2 rounded-lg border border-red-100 active:bg-red-100 transition-colors" title="Reiniciar">
                    <i class="fa-solid fa-rotate-right"></i>
                </button>
                <button onclick="togglePanel()" class="md:hidden text-xs text-slate-500 bg-slate-100 p-2 rounded-lg border border-slate-200 active:bg-slate-200 transition-colors">
                    <i class="fa-solid fa-chevron-left"></i>
                </button>
            </div>
        </div>
        
        <div class="mt-3">
            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Región Tarifaria</label>
            <select id="regionSelect" onchange="updateRegion()" class="block w-full mt-1 p-3 bg-white border border-slate-300 rounded-xl text-sm font-semibold text-slate-700 shadow-sm focus:border-blue-500 outline-none appearance-none">
                <option value="lima">Lima Metropolitana y Callao</option>
                <option value="costa">Costa (Excl. Lima/Callao)</option>
                <option value="sierra">Sierra</option>
                <option value="selva">Selva</option>
            </select>
        </div>
      </div>

      <!-- BODY SCROLLABLE -->
      <div class="flex-1 overflow-y-auto custom-scroll p-4 space-y-6">

        <!-- 1. DATOS GENERALES -->
        <section class="space-y-3 bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
            <h3 class="text-sm font-bold text-slate-700 border-b pb-1">1. Datos Básicos</h3>
            <div class="flex flex-col gap-3">
                <div>
                    <label class="text-xs text-slate-500 font-semibold mb-1 block">Material Predominante</label>
                    <select id="materialSelect" onchange="updateDepreciationDisplay()" class="w-full p-2 bg-slate-50 border rounded-lg text-sm h-10">
                        <option value="concreto">Concreto / Ladrillo</option>
                        <option value="adobe">Adobe / Quincha</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-slate-500 font-semibold mb-1 block">Estado de Conservación</label>
                    <select id="estadoSelect" onchange="updateDepreciationDisplay()" class="w-full p-2 bg-slate-50 border rounded-lg text-sm h-10">
                        <option value="muy_bueno">Muy Bueno</option>
                        <option value="bueno">Bueno</option>
                        <option value="regular">Regular</option>
                        <option value="malo">Malo</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs text-slate-500 font-semibold mb-1 block">Antigüedad (Años)</label>
                    <input type="number" id="antiguedadInput" value="0" min="0" oninput="updateDepreciationDisplay()" class="w-full p-2 bg-slate-50 border rounded-lg text-sm text-right h-10">
                </div>
                <div>
                    <label class="text-xs text-slate-500 font-bold mb-1 block">Área Techada Total (m²)</label>
                    <input type="number" id="areaInput" value="100" min="1" class="w-full p-2 bg-blue-50 border border-blue-200 rounded-lg text-sm font-bold text-right text-blue-800 h-10">
                </div>
            </div>
            
            <div class="bg-yellow-50 p-2 rounded-lg border border-yellow-200 flex justify-between items-center mt-2">
                <span class="text-xs text-yellow-800"><i class="fa-solid fa-arrow-trend-down mr-1"></i> Depreciación</span>
                <span id="deprecDisplay" class="text-sm font-bold text-yellow-900">0%</span>
            </div>
        </section>

        <!-- 2. CATEGORÍAS -->
        <section class="space-y-3 bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
            <div class="flex justify-between items-end border-b pb-1">
                <h3 class="text-sm font-bold text-slate-700">2. Componentes (S/m²)</h3>
            </div>
            <div id="categoriesContainer" class="space-y-3 text-sm">
                <!-- Dinámico - Se llenará vía JS -->
            </div>
        </section>

        <!-- 3. OBRAS COMPLEMENTARIAS -->
        <section class="space-y-3 bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
            <h3 class="text-sm font-bold text-slate-700 border-b pb-1">3. Valores unitarios a costo directo</h3>
            <div class="flex flex-col gap-2">
                <select id="obrasSelect" class="w-full p-2 bg-slate-50 border rounded-lg text-xs h-10">
                    <!-- Dinámico - Se llenará vía JS -->
                </select>
                <div class="flex gap-2">
                    <input type="number" id="obraQty" placeholder="Cant." class="w-20 p-2 border rounded-lg text-xs text-center h-10">
                    <button onclick="addObra()" class="flex-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 h-10 font-bold text-sm active:scale-95 transition-transform">
                        <i class="fa-solid fa-plus mr-1"></i> Agregar
                    </button>
                </div>
            </div>
            <div id="obrasList" class="space-y-2 max-h-48 overflow-y-auto custom-scroll border border-slate-100 rounded-lg bg-gray-50 p-1 min-h-[50px]">
                <div class="text-center py-4 text-xs text-slate-400 italic" id="emptyObrasMsg">Sin obras adicionales</div>
            </div>
        </section>

        <!-- BOTÓN CALCULAR (VERDE) -->
        <button onclick="calculate()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform active:scale-95 transition-all text-lg flex items-center justify-center gap-2 mb-4 border border-green-500">
            <i class="fa-solid fa-calculator"></i> CALCULAR VALOR EDIFICACIÓN
        </button>

        <!-- RESULTADOS -->
        <div class="bg-slate-800 text-white p-4 rounded-xl shadow-lg space-y-4 mb-4">
             <!-- SUBTOTALES -->
            <div class="space-y-1">
                <div class="flex justify-between items-center text-[11px] text-slate-400">
                    <span>1. Subtotal Valor unitario oficial:</span>
                    <span id="subtotalEdif" class="font-mono text-slate-200">S/. 0.00</span>
                </div>
                <div class="flex justify-between items-center text-[11px] text-slate-400">
                    <span>2. Subtotal Obras costo directo:</span>
                    <span id="subtotalObras" class="font-mono text-slate-200">S/. 0.00</span>
                </div>
            </div>
            
            <div class="border-t border-slate-600"></div>
            
            <!-- TOTAL EDIFICACIÓN -->
            <div class="flex justify-between items-end">
                <div>
                    <p class="text-[10px] uppercase tracking-widest text-slate-300 font-bold">Valor de la Edificación</p>
                    <p id="totalFinal" class="text-2xl font-bold leading-none text-green-400">S/. 0.00</p>
                </div>
            </div>

            <!-- VALOR UNITARIO -->
            <div class="flex justify-between items-center bg-slate-700/50 p-2 rounded border border-slate-600">
                <span class="text-[10px] uppercase tracking-widest text-slate-300">Valor Unitario (S/m²)</span>
                <span id="valorUnitarioTotalDisplay" class="font-bold text-slate-200 text-sm">0.00</span>
            </div>

            <!-- SECCIÓN CÁLCULO PREDIO -->
            <div class="bg-slate-700/80 p-3 rounded-lg border border-slate-600">
                <h4 class="text-sm font-bold text-orange-400 mb-2">¿Quieres obtener el valor del predio?</h4>
                <p class="text-[10px] text-slate-400 mb-2 font-mono">VPredio = VTerreno + VEdificación</p>
                
                <label class="text-[10px] text-slate-300 block mb-2 leading-tight">
                    Si ya tienes el valor del terreno, ingrésalo abajo. Si no, consulta el valor arancelario en el icono del mapa inferior.
                </label>
                
                <!-- FÓRMULA VISUAL -->
                <div class="flex items-end gap-2 mb-2 text-xs">
                    <div class="flex-1">
                        <label class="text-[9px] text-slate-400 block mb-1">V. Terreno (S/.)</label>
                        <input type="number" id="valorTerrenoInput" placeholder="0.00" class="w-full p-2 rounded bg-white text-slate-900 font-bold focus:outline-none focus:ring-2 focus:ring-orange-500 text-right" onkeyup="calculatePredio()">
                    </div>
                    <div class="text-slate-400 font-bold pb-2">+</div>
                    <div class="flex-1">
                        <label class="text-[9px] text-slate-400 block mb-1">V. Edificación</label>
                        <div id="displayEdificacionAuto" class="w-full p-2 rounded bg-slate-600 text-slate-300 font-bold text-right border border-slate-500 truncate">
                            0.00
                        </div>
                    </div>
                </div>

                <!-- RESULTADO PREDIO -->
                <div class="flex justify-between items-center mt-3 bg-orange-500/20 p-2 rounded border border-orange-500/50">
                    <span class="text-xs font-bold text-orange-200">V. PREDIO TOTAL:</span>
                    <span id="valorPredioTotal" class="text-lg font-bold text-white">S/. 0.00</span>
                </div>
            </div>
        </div>

      </div>

      <!-- FOOTER FIJO -->
      <div class="bg-black text-white shrink-0 p-4 pb-8 md:pb-4 border-t border-gray-800 z-50 flex flex-col items-center justify-center gap-3 w-full">
          <p class="text-[10px] font-bold text-gray-400 tracking-wide">Elaborado por Lab Urban Risk</p>
          
          <div class="flex items-center gap-6">
               <a href="https://musucancha-rgb.github.io/PERU.Valor_arancelario_terrenos/" target="_blank" class="text-orange-500 hover:text-orange-400 transition-transform transform hover:scale-110" title="Ver Mapa Valores Arancelarios">
                    <i class="fa-solid fa-map-location-dot text-2xl"></i>
                </a>
                <div class="w-px h-6 bg-gray-700"></div>
                <a href="https://youtube.com/@laburbanrisk" target="_blank" class="text-red-500 hover:text-red-400 transition-transform transform hover:scale-110"><i class="fa-brands fa-youtube text-2xl"></i></a>
                <a href="https://www.facebook.com/share/1Db3ZgmTE4/?mibextid=wwXIfr" target="_blank" class="text-blue-600 hover:text-blue-500 transition-transform transform hover:scale-110"><i class="fa-brands fa-facebook text-2xl"></i></a>
                <a href="https://www.instagram.com/laburbanrisk?igsh=MWNzam53enpzZng4Ng%3D%3D&utm_source=qr" target="_blank" class="text-pink-500 hover:text-pink-400 transition-transform transform hover:scale-110"><i class="fa-brands fa-instagram text-2xl"></i></a>
                <a href="https://www.tiktok.com/@laburbanrisk?_r=1&_t=ZN-92idJVeblZe" target="_blank" class="text-white hover:text-gray-300 transition-transform transform hover:scale-110"><i class="fa-brands fa-tiktok text-2xl"></i></a>
          </div>
      </div>

    </div>
  </div>

  <!-- MAPA -->
  <div id="map"></div>

  <!-- LEAFLET JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // --- ESTADO ---
    function saveState() {
        const state = {
            region: document.getElementById('regionSelect').value,
            material: document.getElementById('materialSelect').value,
            estado: document.getElementById('estadoSelect').value,
            antiguedad: document.getElementById('antiguedadInput').value,
            area: document.getElementById('areaInput').value,
            valorTerreno: document.getElementById('valorTerrenoInput').value, 
            obras: currentObras
        };
        localStorage.setItem('calcState', JSON.stringify(state));
    }

    function loadState() {
        const saved = localStorage.getItem('calcState');
        if (saved) {
            try {
                const state = JSON.parse(saved);
                if (state.region) document.getElementById('regionSelect').value = state.region;
                if (state.material) document.getElementById('materialSelect').value = state.material;
                if (state.estado) document.getElementById('estadoSelect').value = state.estado;
                if (state.antiguedad) document.getElementById('antiguedadInput').value = state.antiguedad;
                if (state.area) document.getElementById('areaInput').value = state.area;
                if (state.valorTerreno) document.getElementById('valorTerrenoInput').value = state.valorTerreno;
                currentObras = state.obras || [];
                
                // Forzar actualización inicial
                updateRegion(false);
                renderObrasList();
                updateDepreciationDisplay();
                
                return true;
            } catch (e) { console.error("Error loading state", e); }
        }
        return false;
    }

    // --- DATOS MAESTROS ---
    const MASTER_OBRAS_LIST = [
        {id: 1, name: "Muro concreto armado, e=0.25m h=2.40m", unit: "m2", prices: {lima: 453.45, costa: 443.89, sierra: 444.14, selva: 457.72}},
        {id: 2, name: "Muro traslúcido (tipo UNI) / metálico h=2.40m", unit: "m2", prices: {lima: 417.73, costa: 408.92, sierra: 409.15, selva: 421.66}},
        // ... (resto de ítems) ...
        {id: 96, name: "Trampa de concreto armado para grasa", unit: "m3", prices: {lima: 1356.39, costa: 1327.80, sierra: 1328.54, selva: 1369.17}}
    ];

    const DEPRECIATION_DATA_CONCRETO = {
        0: [0, 5, 10, 55], 5: [3, 8, 15, 58], 10: [6, 11, 20, 61], 15: [9, 14, 25, 64],
        20: [12, 17, 30, 67], 25: [15, 20, 35, 70], 30: [18, 23, 40, 73], 35: [21, 26, 45, 76],
        40: [24, 29, 50, 79], 45: [27, 32, 55, 82], 50: [30, 35, 60, 85] 
    };

    const DEPRECIATION_DATA_ADOBE = {
        0: [5, 10, 15, 65], 5: [10, 15, 20, 68], 10: [15, 20, 25, 71], 15: [20, 25, 30, 74],
        20: [25, 30, 35, 77], 25: [30, 35, 40, 80], 30: [35, 40, 45, 83]
    };

    const DATA_REGIONES = {
        'lima': {
            name: "Lima Metropolitana y Callao",
            components: [
                { id: 'muros', label: '1. Muros y Columnas', cats: [
                    {cat:'A', val:976.30}, {cat:'B', val:629.46}, {cat:'C', val:422.98}, {cat:'D', val:409.04}, {cat:'E', val:287.96}, {cat:'F', val:222.15}, {cat:'G', val:127.78}
                ]},
                { id: 'techos', label: '2. Techos', cats: [
                    {cat:'A', val:592.97}, {cat:'B', val:386.87}, {cat:'C', val:312.01}, {cat:'D', val:198.04}, {cat:'E', val:73.83}, {cat:'F', val:41.60}, {cat:'G', val:27.91}
                ]},
                { id: 'pisos', label: '3. Pisos', cats: [
                    {cat:'A', val:529.84}, {cat:'B', val:279.28}, {cat:'C', val:176.22}, {cat:'D', val:154.35}, {cat:'E', val:132.06}, {cat:'F', val:101.56}, {cat:'G', val:53.56}
                ]},
                { id: 'puertas', label: '4. Puertas y Ventanas', cats: [
                    {cat:'A', val:529.84}, {cat:'B', val:279.28}, {cat:'C', val:176.22}, {cat:'D', val:154.35}, {cat:'E', val:132.06}, {cat:'F', val:101.56}, {cat:'G', val:53.56}
                ]}
            ]
        },
        'costa': {
            name: "Costa",
            components: [
                { id: 'muros', label: '1. Muros y Columnas', cats: [{cat:'A', val:894.27}, {cat:'B', val:576.57}, {cat:'C', val:387.43}, {cat:'D', val:374.68}, {cat:'E', val:263.77}, {cat:'F', val:198.64}, {cat:'G', val:117.05}] },
                { id: 'techos', label: '2. Techos', cats: [{cat:'A', val:543.16}, {cat:'B', val:354.37}, {cat:'C', val:285.80}, {cat:'D', val:181.40}, {cat:'E', val:67.63}, {cat:'F', val:37.19}, {cat:'G', val:25.57}] },
                { id: 'pisos', label: '3. Pisos', cats: [{cat:'A', val:485.33}, {cat:'B', val:255.81}, {cat:'C', val:161.41}, {cat:'D', val:141.39}, {cat:'E', val:120.98}, {cat:'F', val:90.81}, {cat:'G', val:49.05}] },
                { id: 'puertas', label: '4. Puertas y Ventanas', cats: [{cat:'A', val:485.33}, {cat:'B', val:255.81}, {cat:'C', val:161.41}, {cat:'D', val:141.39}, {cat:'E', val:120.98}, {cat:'F', val:90.81}, {cat:'G', val:49.05}] }
            ]
        },
        'sierra': {
            name: "Sierra",
            components: [
                { id: 'muros', label: '1. Muros y Columnas', cats: [{cat:'A', val:1010.95}, {cat:'B', val:601.44}, {cat:'C', val:425.98}, {cat:'D', val:393.47}, {cat:'E', val:308.89}, {cat:'F', val:192.61}, {cat:'G', val:113.49}] },
                { id: 'techos', label: '2. Techos', cats: [{cat:'A', val:525.66}, {cat:'B', val:361.40}, {cat:'C', val:246.87}, {cat:'D', val:251.48}, {cat:'E', val:76.73}, {cat:'F', val:61.30}, {cat:'G', val:0.00}] },
                { id: 'pisos', label: '3. Pisos', cats: [{cat:'A', val:399.00}, {cat:'B', val:353.08}, {cat:'C', val:147.50}, {cat:'D', val:112.67}, {cat:'E', val:87.12}, {cat:'F', val:51.34}, {cat:'G', val:25.67}] },
                { id: 'puertas', label: '4. Puertas y Ventanas', cats: [{cat:'A', val:399.00}, {cat:'B', val:353.08}, {cat:'C', val:147.50}, {cat:'D', val:112.67}, {cat:'E', val:87.12}, {cat:'F', val:51.34}, {cat:'G', val:25.67}] }
            ]
        },
        'selva': {
            name: "Selva",
            components: [
                { id: 'muros', label: '1. Muros y Columnas', cats: [{cat:'A', val:995.50}, {cat:'B', val:679.21}, {cat:'C', val:489.75}, {cat:'D', val:378.67}, {cat:'E', val:300.68}, {cat:'F', val:205.37}, {cat:'G', val:102.68}, {cat:'H', val:41.08}] },
                { id: 'techos', label: '2. Techos', cats: [{cat:'A', val:509.83}, {cat:'B', val:360.15}, {cat:'C', val:265.25}, {cat:'D', val:231.25}, {cat:'E', val:168.37}, {cat:'F', val:60.91}, {cat:'G', val:77.41}] },
                { id: 'pisos', label: '3. Pisos', cats: [{cat:'A', val:421.72}, {cat:'B', val:334.51}, {cat:'C', val:248.79}, {cat:'D', val:166.76}, {cat:'E', val:108.28}, {cat:'F', val:88.32}, {cat:'G', val:52.11}] },
                { id: 'puertas', label: '4. Puertas y Ventanas', cats: [{cat:'A', val:421.72}, {cat:'B', val:334.51}, {cat:'C', val:248.79}, {cat:'D', val:166.76}, {cat:'E', val:108.28}, {cat:'F', val:88.32}, {cat:'G', val:52.11}] }
            ]
        }
    };

    // --- MAPA ---
    const map = L.map("map", { zoomControl: false }).setView([-9.19, -75.0152], 6);
    L.control.zoom({ position: 'topright' }).addTo(map);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; Lab Urban Risk', subdomains: 'abcd', maxZoom: 20
    }).addTo(map);

    // --- LÓGICA CALCULADORA ---
    let currentObras = [];

    function init() {
        const hasSaved = loadState();
        if(!hasSaved) {
            updateRegion(); 
        } else {
            // No resetear categorías al cargar estado guardado
            updateRegion(false); 
            renderObrasList();
        }
        
        // Ajuste inicial para móviles
        if(window.innerWidth < 768) {
            closePanel();
        }
    }

    function updateRegion(resetCats = true) {
        const regionKey = document.getElementById('regionSelect').value;
        const data = DATA_REGIONES[regionKey];
        const container = document.getElementById('categoriesContainer');
        container.innerHTML = '';
        
        data.components.forEach(comp => {
            let html = `
                <div class="bg-slate-50 p-2.5 border border-slate-200 rounded-lg">
                    <div class="text-xs font-bold text-slate-600 mb-1.5">${comp.label}</div>
                    <select class="category-select w-full p-2.5 text-sm border border-slate-200 rounded-lg bg-white h-11 focus:border-blue-500 outline-none">
                        <option value="0" data-val="0">-- Seleccionar --</option>
            `;
            comp.cats.forEach(cat => {
                html += `<option value="${cat.cat}" data-val="${cat.val}">Cat. ${cat.cat} - S/. ${cat.val.toFixed(2)}</option>`;
            });
            html += `</select></div>`;
            container.innerHTML += html;
        });

        const obrasSelect = document.getElementById('obrasSelect');
        obrasSelect.innerHTML = '<option value="">-- Seleccionar obra(s) y/o instalación(es) --</option>';
        MASTER_OBRAS_LIST.forEach(obra => {
            const price = obra.prices[regionKey] || 0;
            obrasSelect.innerHTML += `<option value="${obra.id}" data-val="${price}" data-name="${obra.name}" data-unit="${obra.unit}">${obra.name}</option>`;
        });

        if(geojson) {
            geojson.eachLayer(layer => layer.setStyle(style(layer.feature)));
        }
        
        // No llamamos a calculate() aquí para evitar resetear valores si estamos cargando estado
        saveState();
    }

    // --- NUEVA LÓGICA DEPRECIACIÓN EN TIEMPO REAL ---
    function updateDepreciationDisplay() {
        const mat = document.getElementById('materialSelect').value;
        const est = document.getElementById('estadoSelect').value;
        const age = parseInt(document.getElementById('antiguedadInput').value) || 0;
        
        const pct = getDepreciationPct(mat, est, age);
        document.getElementById('deprecDisplay').innerText = pct + "%";
        
        saveState();
    }

    function getDepreciationPct(material, state, age) {
        // Mapeo de estados a índices [MB, B, R, M]
        const stateMap = { 'muy_bueno': 0, 'bueno': 1, 'regular': 2, 'malo': 3 };
        const stateIdx = stateMap[state];
        
        // Determinar tabla base
        let tableData = (material === 'adobe') ? DEPRECIATION_DATA_ADOBE : DEPRECIATION_DATA_CONCRETO;
        
        // Encontrar intervalo de edad
        let years = Object.keys(tableData).map(Number).sort((a,b)=>a-b);
        let validYear = years[0];
        
        for(let y of years) {
            if (age >= y) validYear = y;
        }
        
        // Si la edad supera el máximo de la tabla, usamos el máximo
        let row = tableData[validYear];
        if (!row) {
            validYear = years[years.length-1];
            row = tableData[validYear];
        }

        return row[stateIdx];
    }

    // --- CÁLCULO ---
    function calculate() {
        // 1. Unitario
        let totalUnitario = 0;
        const selects = document.querySelectorAll('.category-select');
        
        if (selects.length === 0) {
            console.warn("No se encontraron selectores de categoría");
            return;
        }

        selects.forEach(sel => {
            if (sel.selectedIndex >= 0) {
                const selectedOpt = sel.options[sel.selectedIndex];
                const val = parseFloat(selectedOpt.getAttribute('data-val'));
                if (!isNaN(val)) {
                    totalUnitario += val;
                }
            }
        });
        
        const valorUnitarioElement = document.getElementById('valorUnitarioTotalDisplay');
        if(valorUnitarioElement) {
            valorUnitarioElement.innerText = totalUnitario.toFixed(2);
        }

        // 2. Depreciación
        const mat = document.getElementById('materialSelect').value;
        const est = document.getElementById('estadoSelect').value;
        const age = parseInt(document.getElementById('antiguedadInput').value) || 0;
        const deprecPct = getDepreciationPct(mat, est, age);
        const factorDepreciacion = 1 - (deprecPct / 100);

        // 3. Subtotales
        const area = parseFloat(document.getElementById('areaInput').value) || 0;
        const subtotal1 = totalUnitario * area * factorDepreciacion;
        document.getElementById('subtotalEdif').innerText = "S/. " + subtotal1.toLocaleString('es-PE', {minimumFractionDigits: 2, maximumFractionDigits: 2});

        let subtotal2 = 0;
        currentObras.forEach(o => subtotal2 += o.total);
        document.getElementById('subtotalObras').innerText = "S/. " + subtotal2.toLocaleString('es-PE', {minimumFractionDigits: 2, maximumFractionDigits: 2});

        // 4. Total
        const totalEdificacion = subtotal1 + subtotal2;
        document.getElementById('totalFinal').innerText = "S/. " + totalEdificacion.toLocaleString('es-PE', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        
        // Update campo auto en predio
        document.getElementById('displayEdificacionAuto').innerText = totalEdificacion.toLocaleString('es-PE', {minimumFractionDigits: 2, maximumFractionDigits: 2});

        // 5. Predio
        calculatePredio(totalEdificacion);
        
        saveState();
    }

    function calculatePredio(totalEdif) {
        let valEdificacion = totalEdif;
        if (typeof valEdificacion === 'undefined') {
             const text = document.getElementById('displayEdificacionAuto').innerText.replace(/,/g, '');
             valEdificacion = parseFloat(text) || 0;
        }

        const valTerreno = parseFloat(document.getElementById('valorTerrenoInput').value) || 0;
        const valPredio = valEdificacion + valTerreno;
        
        document.getElementById('valorPredioTotal').innerText = "S/. " + valPredio.toLocaleString('es-PE', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        saveState();
    }

    function addObra() {
        const sel = document.getElementById('obrasSelect');
        if(sel.selectedIndex < 0) return;
        
        const opt = sel.options[sel.selectedIndex];
        if(!opt.value) return;

        const qty = parseFloat(document.getElementById('obraQty').value) || 0;
        if(qty <= 0) return;

        const val = parseFloat(opt.getAttribute('data-val'));
        const name = opt.getAttribute('data-name');
        const unit = opt.getAttribute('data-unit');

        currentObras.push({
            id: Date.now(),
            name: name,
            qty: qty,
            unit: unit,
            val: val,
            total: val * qty
        });

        renderObrasList();
        document.getElementById('obraQty').value = '';
        sel.value = "";
        
        // No llamamos a calculate() automáticamente, el usuario debe pulsar el botón
    }

    function removeObra(id) {
        currentObras = currentObras.filter(o => o.id !== id);
        renderObrasList();
    }

    function renderObrasList() {
        const list = document.getElementById('obrasList');
        if (currentObras.length === 0) {
            list.innerHTML = '<div class="text-center py-4 text-xs text-slate-400 italic" id="emptyObrasMsg">Sin obras adicionales</div>';
            return;
        }

        list.innerHTML = '';
        currentObras.forEach(o => {
            list.innerHTML += `
                <div class="flex justify-between items-center bg-white p-2.5 border border-slate-200 rounded-lg text-xs mb-1.5 last:mb-0 shadow-sm">
                    <div>
                        <div class="font-bold text-slate-700 w-40 truncate" title="${o.name}">${o.name}</div>
                        <div class="text-slate-500">${o.qty} ${o.unit} x S/.${o.val.toFixed(2)}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-blue-700">S/.${o.total.toFixed(0)}</span>
                        <button onclick="removeObra(${o.id})" class="text-red-400 hover:text-red-600 p-2 bg-red-50 rounded"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `;
        });
    }

    function resetCalculator() {
        if(confirm("¿Reiniciar calculadora?")) {
            localStorage.removeItem('calcState');
            document.getElementById('antiguedadInput').value = 0;
            document.getElementById('areaInput').value = 100;
            document.getElementById('materialSelect').selectedIndex = 0;
            document.getElementById('estadoSelect').selectedIndex = 0;
            document.getElementById('valorTerrenoInput').value = ''; 
            currentObras = [];
            renderObrasList();
            updateRegion();
            updateDepreciationDisplay();
            
            // Clear results
            document.getElementById('subtotalEdif').innerText = "S/. 0.00";
            document.getElementById('subtotalObras').innerText = "S/. 0.00";
            document.getElementById('totalFinal').innerText = "S/. 0.00";
            document.getElementById('displayEdificacionAuto').innerText = "0.00";
            document.getElementById('valorPredioTotal').innerText = "S/. 0.00";
            const valUnitElem = document.getElementById('valorUnitarioTotalDisplay');
            if(valUnitElem) valUnitElem.innerText = "0.00";
        }
    }

    // --- UI TOGGLE ---
    const toggleBtn = document.getElementById('toggleSideBtn');
    const mainPanel = document.getElementById('mainPanel');
    const mobileToggleBtn = document.getElementById('mobileToggleBtn');
    const mobileToggleIcon = document.getElementById('mobileToggleIcon');
    const uiContainer = document.getElementById('uiContainer');
    let isOpen = true;

    function closePanel() {
        mainPanel.classList.remove('panel-visible');
        mainPanel.classList.add('panel-hidden');
        if(toggleBtn) toggleBtn.classList.remove('hidden');
        
        if(mobileToggleBtn) { 
            mobileToggleBtn.classList.remove('hidden');
            if(mobileToggleIcon) mobileToggleIcon.className = "fa-solid fa-chevron-right text-xs";
        }
        isOpen = false;
    }

    function openPanel() {
        mainPanel.classList.remove('panel-hidden');
        mainPanel.classList.add('panel-visible');
        if(toggleBtn) toggleBtn.classList.add('hidden');
        if(mobileToggleBtn) {
            mobileToggleBtn.classList.add('hidden');
        }
        isOpen = true;
    }

    if(toggleBtn) toggleBtn.addEventListener('click', openPanel);
    if(mobileToggleBtn) mobileToggleBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        openPanel();
    });

    // --- 4. MAPA ---
    let selectedLayer = null;

    function style(feature) {
      const ubigeo = feature.properties.ubigeo || feature.properties.UBIGEO || "";
      const region = detectRegion(ubigeo);
      const selectedRegion = document.getElementById('regionSelect') ? document.getElementById('regionSelect').value : 'lima';
      const isActive = region === selectedRegion;

      return {
        color: isActive ? "#2563eb" : "#94a3b8",
        weight: isActive ? 1.5 : 0.5, 
        opacity: 1,
        fillColor: isActive ? "#3b82f6" : "#cbd5e1",
        fillOpacity: isActive ? 0.4 : 0.1
      };
    }

    function highlightStyle() { return { weight: 2, color: '#0047FF', fillColor: '#0047FF', fillOpacity: 0.8 }; }

    function resetHighlight(e) { if (e.target !== selectedLayer) e.target.setStyle(style(e.target.feature)); }
    function highlightFeature(e) { 
        if (e.target !== selectedLayer) {
            e.target.setStyle(highlightStyle());
            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) e.target.bringToFront();
        }
    }

    function detectRegion(ubigeo) {
        if (!ubigeo) return 'costa'; 
        const dep = ubigeo.substring(0, 2);
        if (dep === '15' || dep === '07') return 'lima';
        if (['16', '17', '25', '01', '22'].includes(dep)) return 'selva';
        if (['08', '21', '03', '05', '09', '10', '12', '19', '06'].includes(dep)) return 'sierra';
        return 'costa';
    }

    function selectFeature(layer) {
        if (selectedLayer && selectedLayer !== layer) {
             const prevLayer = selectedLayer;
             selectedLayer = null; 
             prevLayer.setStyle(style(prevLayer.feature));
        }
        selectedLayer = layer;
        layer.setStyle(highlightStyle());
        layer.bringToFront();
        map.flyToBounds(layer.getBounds(), { padding: [20, 20], maxZoom: 13, duration: 1.2 });
        
        const props = layer.feature.properties;
        const distName = props.distrito || props.NOMBDIST || "Distrito Seleccionado";
        const ubigeo = props.ubigeo || props.UBIGEO || "";
        const detectedRegion = detectRegion(ubigeo);
        
        document.getElementById('regionSelect').value = detectedRegion;
        document.getElementById('selectedDistrictDisplay').innerHTML = `<i class="fa-solid fa-location-dot mr-1"></i> ${distName} (${detectedRegion.toUpperCase()})`;
        
        updateRegion(true);
        if(window.innerWidth < 768) openPanel();
    }

    function onEachFeature(feature, layer) {
      layer.on({ mouseover: highlightFeature, mouseout: resetHighlight, click: (e) => { L.DomEvent.stopPropagation(e); selectFeature(layer); } });
    }

    fetch("distritos_mef_2026_con_zip.geojson")
      .then(r => { if (!r.ok) throw new Error("Err"); return r.json(); })
      .then(data => {
        geojson = L.geoJSON(data, { style, onEachFeature }).addTo(map);
        map.fitBounds(geojson.getBounds());
      })
      .catch(err => {
        // Fallback or demo mode handled silently or alert
      });

    init();
  </script>
</body>
</html>
